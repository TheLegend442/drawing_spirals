<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Pencil Coordinate Logger</title>
<style>
  body {
    margin: 0;
    display: flex;
    flex-direction: column;
    align-items: center;
    background: #eee;
    font-family: sans-serif;
  }
  #controls {
    margin: 10px;
    display: flex;
    gap: 10px;
  }
  canvas {
    border: 1px solid #444;
    touch-action: none; /* important for iPad Pencil */
    background: white;
  }
</style>
</head>
<body>
  <div id="controls">
    <input type="file" id="templateInput" accept="image/*">
    <button id="clearBtn">Clear</button>
    <button id="exportBtn">Export CSV</button>
  </div>
  <canvas id="canvas" width="800" height="600"></canvas>

<script>
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');
let drawing = false;
let points = [];
let bgImage = null;
let bgImageDrawInfo = null;

// ---- Upload template image ----
document.getElementById('templateInput').addEventListener('change', (e) => {
  const file = e.target.files[0];
  if (!file) return;
  const img = new Image();
  img.onload = () => {
    bgImage = img;
    ctx.clearRect(0, 0, canvas.width, canvas.height);

    // calculate aspect ratio scaling
    const canvasRatio = canvas.width / canvas.height;
    const imgRatio = img.width / img.height;
    let drawWidth, drawHeight, offsetX, offsetY;

    if (imgRatio > canvasRatio) {
      drawWidth = canvas.width;
      drawHeight = canvas.width / imgRatio;
      offsetX = 0;
      offsetY = (canvas.height - drawHeight) / 2;
    } else {
      drawHeight = canvas.height;
      drawWidth = canvas.height * imgRatio;
      offsetX = (canvas.width - drawWidth) / 2;
      offsetY = 0;
    }

    ctx.drawImage(img, offsetX, offsetY, drawWidth, drawHeight);
    bgImageDrawInfo = { offsetX, offsetY, drawWidth, drawHeight };
  };
  img.src = URL.createObjectURL(file);
});

// ---- Clear canvas ----
document.getElementById('clearBtn').addEventListener('click', () => {
  points = [];
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  if (bgImage && bgImageDrawInfo) {
    ctx.drawImage(
      bgImage,
      bgImageDrawInfo.offsetX,
      bgImageDrawInfo.offsetY,
      bgImageDrawInfo.drawWidth,
      bgImageDrawInfo.drawHeight
    );
  }
});

// ---- Drawing handlers ----
canvas.addEventListener('pointerdown', (e) => {
  if (e.pointerType === 'pen') {
    drawing = true;
    addPoint(e);
  }
});

canvas.addEventListener('pointermove', (e) => {
  if (drawing && e.pointerType === 'pen') {
    addPoint(e);
    drawLine();
  }
});

canvas.addEventListener('pointerup', () => drawing = false);
canvas.addEventListener('pointercancel', () => drawing = false);

function addPoint(e) {
  const rect = canvas.getBoundingClientRect();
  const x = e.clientX - rect.left;
  const y = e.clientY - rect.top;
  const t = performance.now();
  points.push({ t, x, y });
  window.drawData = points; // optional: store globally
}

function drawLine() {
  if (points.length < 2) return;
  const p1 = points[points.length - 2];
  const p2 = points[points.length - 1];
  ctx.beginPath();
  ctx.moveTo(p1.x, p1.y);
  ctx.lineTo(p2.x, p2.y);
  ctx.strokeStyle = 'black';
  ctx.lineWidth = 1.5;
  ctx.stroke();
}

// ---- Export to CSV ----
const exportBtn = document.getElementById('exportBtn');

exportBtn.addEventListener('click', () => {
    const now = new Date();
    const timestamp = now.toISOString().replace(/[:.]/g,'-');
    const filename = `drawing_${timestamp}.csv`;

    let csvContent = "timestamp_ms,x,y\n";
    for (const point of points) {
        csvContent += `${point.t},${point.x},${point.y}\n`;
    }

    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement("a");
    link.setAttribute("href", URL.createObjectURL(blob));
    link.setAttribute("download", filename);
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
});
</script>
</body>
</html>